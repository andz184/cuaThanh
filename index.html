<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω V·∫≠n T·∫£i Eco</title>
    <!-- Th∆∞ vi·ªán JsBarcode ƒë·ªÉ t·∫°o m√£ v·∫°ch -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Th∆∞ vi·ªán Google Sheets API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        /* CSS cho to√†n b·ªô trang */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            min-height: 100vh;
        }

        /* Navigation */
        .nav-container {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #2980b9;
        }

        .nav-btn.active {
            background: #e74c3c;
        }

        /* View containers */
        .view-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .view-container.active {
            display: block;
        }

        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .data-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Form styles */
        .form-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .status-active {
            background: #27ae60;
            color: white;
        }

        .status-completed {
            background: #3498db;
            color: white;
        }

        .status-cancelled {
            background: #e74c3c;
            color: white;
        }

        /* Grid layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
        }

        /* Container ch√≠nh c·ªßa h√≥a ƒë∆°n - TƒÉng k√≠ch th∆∞·ªõc l√™n 1.15 l·∫ßn */
        .bill-container {
            width: calc(8.5in * 1.15); /* TƒÉng chi·ªÅu r·ªông l√™n 1.15 l·∫ßn */
            background-color: white;
            border: 1px solid #000;
            box-shadow: 0 0 0px rgba(0, 0, 0, 0.1);
            position: relative;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 1.15em; /* TƒÉng k√≠ch th∆∞·ªõc ch·ªØ t·ªïng th·ªÉ */
        }

        /* Header - V·∫≠n t·∫£i ECO v√† m√£ v·∫°ch */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 5px;
            border-bottom: 2px solid #000;
        }

        .header-left {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        /* CSS cho logo v√† QR code trong header */
        .header-left .logo {
            width: calc(40px * 1.15);
            height: calc(40px * 1.15);
            margin-right: calc(5px * 1.15);
        }
        
        /* Lo·∫°i b·ªè CSS c·ªßa SVG c≈© */
        .header-left svg {
            display: none;
        }

        .company-info h1 {
            font-size: 1.15rem;
            font-weight: bold;
            margin: 0;
            color: #000;
        }

        .company-info h2 {
            font-size: 0.8rem;
            font-weight: normal;
            margin: 0;
        }
        
        .company-info p {
            font-size: 0.7rem;
            margin: 1px 0;
            line-height: 1.2;
        }

        .hotline {
            color: #e74c3c;
            font-weight: bold;
        }
        
        /* C·∫≠p nh·∫≠t CSS ƒë·ªÉ m√£ v·∫°ch hi·ªÉn th·ªã ƒë√∫ng v√† l·ªõn h∆°n */
        .header-right {
            display: flex;
            justify-content: flex-end;
            text-align: right;
            padding-left: 10px;
        }
        
        .header-right #barcode-svg {
            display: block;
            margin-bottom: 5px;
            width: calc(180px * 1.15);
            height: calc(50px * 1.15);
            background-color: transparent;
            color: #000;
        }

        /* Ph·∫ßn th√¥ng tin ng∆∞·ªùi g·ª≠i/nh·∫≠n */
        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border: 1px solid #000;
            flex-grow: 1;
        }

        .info-panel {
            padding: 3px 5px;
        }

        .info-panel.border-right {
            border-right: 1px solid #000;
        }

        .info-panel .item {
            display: flex;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }
        .info-panel .item .label {
            font-weight: bold;
            min-width: 90px;
            white-space: nowrap;
        }

        /* Ph·∫ßn h√†ng h√≥a v√† c∆∞·ªõc ph√≠ */
        .content-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid #000;
            flex-grow: 1;
        }
        .main-content {
            border-right: 1px solid #000;
        }
        .content-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            table-layout: fixed;
        }
        .content-table th, .content-table td {
            border: 1px solid #000;
            padding: 3px;
            text-align: center;
        }
        .content-table th {
            background-color: #f2f2f2;
        }
        .notes-table {
            border-top: 1px solid #000;
        }
        .notes-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            table-layout: fixed;
        }
        .notes-table th, .notes-table td {
            border: 1px solid #000;
            padding: 3px;
            text-align: center;
        }
        .notes-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .side-content {
            padding: 3px 5px;
            display: flex;
            flex-direction: column;
        }
        .side-content .item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }
        .side-content .item .label {
            font-weight: bold;
        }
        .side-content .item .value {
            text-align: right;
            border-bottom: 1px dashed #000;
        }
        .item-separator {
            border-bottom: 1px solid #000;
            margin: 5px 0;
        }
        .side-content .value-money {
            font-size: 1.1rem;
            font-weight: normal;
            text-align: right;
            border-bottom: 1px dashed #000;
        }
        .side-content .item:nth-of-type(3) {
            margin-top: auto;
        }
        .side-content .total-cost {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            padding-top: 3px;
            border-top: 1px solid #000;
        }
        .side-content .total-cost .label {
            font-weight: bold;
        }
        .side-content .total-cost .value-money {
            font-size: 1.3rem;
            font-weight: normal;
            color: #e74c3c;
        }
        
        /* Ch·ªØ k√Ω v√† c√°c th√¥ng tin kh√°c */
        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            text-align: center;
            font-size: 0.8rem;
            border-top: 1px solid #000;
            padding-bottom: 5px;
        }
        .signature-box {
            padding: 5px;
            min-height: 2cm;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 5px;
        }
        .signature-box.border-right {
            border-right: 1px solid #000;
        }
        .signature-box p {
            margin: 0;
            line-height: 1.5;
        }
        .signature-box .date-time {
            margin-bottom: 0;
            border-bottom: 1px dashed #000;
        }
        
        .recipient-signature {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 10px;
        }
        .recipient-signature .employee-label {
            margin-left: auto;
            text-align: right;
            line-height: 1.2;
            padding-left: 10px;
        }

        /* Footer */
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 5px;
            font-size: 0.8rem;
        }
        .qr-note-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .qr-code {
            width: calc(40px * 1.15);
            height: calc(40px * 1.15);
            margin-right: 5px;
        }
        .qr-note {
            margin: 0;
            line-height: 1.2;
            font-size: 0.7rem;
            white-space: nowrap;
            width: auto;
        }
        .footer-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            text-align: right;
        }
        .print-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        /* --- THAY TH·∫æ TO√ÄN B·ªò KH·ªêI IN --- */
        @media print {
            /* Kh·ªï gi·∫•y A4 d·ªçc, l·ªÅ m·ªèng ƒë·ªÉ tƒÉng v√πng in */
            @page {
                size: A4 portrait; /* Thay ƒë·ªïi kh·ªï gi·∫•y v√† h∆∞·ªõng */
                margin: 5mm;
            }

            /* C·ªë ƒë·ªãnh k√≠ch th∆∞·ªõc trang ƒë·ªÉ tr√¨nh duy·ªát canh ƒë√∫ng */
            html, body {
                width: 210mm; /* Chi·ªÅu r·ªông c·ªßa A4 */
                height: 297mm; /* Chi·ªÅu cao c·ªßa A4 */
                margin: 0 !important;
                padding: 0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background: #fff !important;

                /* --- TH√äM C√ÅC THU·ªòC T√çNH N√ÄY --- */
                display: flex; /* S·ª≠ d·ª•ng Flexbox cho body */
                justify-content: center; /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
                align-items: flex-start; /* CƒÉn d·ªçc v·ªÅ ƒë·∫ßu trang (top) */
                /* --- K·∫æT TH√öC PH·∫¶N TH√äM --- */
            }

            /* T·∫Øt b√≥ng/vi·ªÅn th·ª´a, ƒë·∫∑t b·ªÅ r·ªông theo v√πng in */
            .bill-container {
                box-shadow: none !important;
                border: 1px solid #000;  /* gi·ªØ vi·ªÅn ngo√†i */
                width: 200mm;            /* 210mm - 2*5mm l·ªÅ = 200mm */
                max-width: 200mm;
                padding: 5px;            /* gi·ªØ padding nh·ªè ƒë·ªÉ kh√¥ng tr√†n */
                font-size: 1.0em;        /* in g·ªçn h∆°n 1 ch√∫t so v·ªõi m√†n h√¨nh */
                /* Th√™m chi·ªÅu cao ƒë·ªÉ chi·∫øm n·ª≠a trang, b·∫°n c√≥ th·ªÉ c·∫ßn ƒëi·ªÅu ch·ªânh */
                height: 140mm; /* Kho·∫£ng m·ªôt n·ª≠a chi·ªÅu cao A4, c√≥ th·ªÉ c·∫ßn tinh ch·ªânh */
                overflow: hidden; /* ƒê·∫£m b·∫£o n·ªôi dung kh√¥ng tr√†n n·∫øu v∆∞·ª£t qu√° */

                /* --- TH√äM C√ÅC THU·ªòC T√çNH N√ÄY ƒê·ªÇ ƒê·∫¢M B·∫¢O KH√îNG B·ªä L·ªñI CƒÇN CH·ªàNH KHI IN --- */
                margin-top: 0 !important; /* Lo·∫°i b·ªè margin-top n·∫øu c√≥ t·ª´ c√°c ƒë·ªãnh nghƒ©a kh√°c */
                /* --- K·∫æT TH√öC PH·∫¶N TH√äM --- */
            }

            /* Ch·∫∑n ng·∫Øt trang gi·ªØa c√°c kh·ªëi ch√≠nh */
            .header,
            .info-section,
            .content-section,
            .signature-section,
            .footer {
                break-inside: avoid;
                page-break-inside: avoid;
            }

        /* ·∫®n n√∫t in khi in */
        .print-button { display: none !important; }
    }
    </style>
</head>
<body>

<!-- Navigation -->
<div class="nav-container">
    <h2>üöõ H·ªá Th·ªëng Qu·∫£n L√Ω V·∫≠n T·∫£i ECO</h2>
    <div class="nav-buttons">
        <button class="nav-btn active" onclick="showView('bill')">üìÑ H√≥a ƒê∆°n</button>
        <button class="nav-btn" onclick="showView('vehicles')">üöõ Qu·∫£n L√Ω Xe</button>
        <button class="nav-btn" onclick="showView('assign-bills')">üìã X·∫øp Bill Cho Xe</button>
        <button class="nav-btn" onclick="showView('vehicle-status')">üìä Tr·∫°ng Th√°i Xe</button>
        <button class="nav-btn" onclick="showView('unassigned-bills')">üì¶ ƒê∆°n Ch∆∞a X·∫øp</button>
        <button class="nav-btn" onclick="showView('vehicle-bills')">üìã Qu·∫£n L√Ω Bill Tr√™n Xe</button>
        <button class="nav-btn" onclick="showView('local-data')">üíæ D·ªØ Li·ªáu Local</button>
    </div>
</div>

<!-- View: H√≥a ƒê∆°n (m·∫∑c ƒë·ªãnh) -->
<div id="bill-view" class="view-container active">
<div class="bill-container scale-print">
    <!-- Header: Logo, t√™n c√¥ng ty v√† m√£ v·∫°ch -->
    <div class="header">
        <div class="header-left">
            <!-- Logo c≈© ƒë∆∞·ª£c gi·ªØ l·∫°i -->
            <img class="logo" src="https://tuducdat2001-cyber.github.io/bill/z6887164537636_0c445e9b4d6e1687482f51f307b359e5.jpg" alt="Logo C√¥ng ty">
            <div class="company-info">
                <h1>V·∫¨N T·∫¢I ECO</h1>
                <h2>V·∫¨N CHUY·ªÇN H√ÄNG HO√Å B·∫ÆC - NAM</h2>
                <p>Express & Exacting</p>
                <p class="hotline">Hotline 0946 936 999-0888.805.625</p>
            </div>
        </div>
        <div class="header-right">
            <!-- M√£ v·∫°ch ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông -->
            <svg id="barcode-svg"></svg>
        </div>
    </div>
    
    <!-- Ph·∫ßn th√¥ng tin ng∆∞·ªùi g·ª≠i v√† ng∆∞·ªùi nh·∫≠n -->
    <div class="info-section">
        <div class="info-panel border-right">
            <div class="item">
                <span class="label">T√™n kh√°ch g·ª≠i:</span>
                <span class="value" id="tenNguoiGui"></span>
            </div>
            <div class="item">
                <span class="label">ƒê·ªãa ch·ªâ:</span>
                <span class="value" id="diaChiNguoiGui"></span>
            </div>
            <div class="item">
                <span class="label">X√£, Ph∆∞·ªùng:</span>
                <span class="value" id="xaPhuongGui"></span>
            </div>
            <div class="item">
                <span class="label">T·ªânh/ TP:</span>
                <span class="value" id="tinhTPGui"></span>
            </div>
            <div class="item">
                <span class="label">S·ªë ƒëi·ªán tho·∫°i:</span>
                <span class="value" id="sdtNguoiGui"></span>
            </div>
        </div>
        <div class="info-panel">
            <div class="item">
                <span class="label">T√™n kh√°ch nh·∫≠n:</span>
                <span class="value" id="tenNguoiNhan"></span>
            </div>
            <div class="item">
                <span class="label">ƒê·ªãa ch·ªâ:</span>
                <span class="value" id="diaChiNguoiNhan"></span>
            </div>
            <div class="item">
                <span class="label">X√£, Ph∆∞·ªùng:</span>
                <span class="value" id="xaPhuongNhan"></span>
            </div>
            <div class="item">
                <span class="label">T·ªânh/ TP:</span>
                <span class="value" id="tinhTPNhan"></span>
            </div>
            <div class="item">
                <span class="label">S·ªë ƒëi·ªán tho·∫°i:</span>
                <span class="value" id="sdtNguoiNhan"></span>
            </div>
        </div>
    </div>
    
    <!-- Ph·∫ßn h√†ng h√≥a v√† c∆∞·ªõc ph√≠ -->
    <div class="content-section">
        <div class="main-content">
            <div class="content-table">
                <table>
                    <thead>
                        <tr>
                            <th>D·ªãch v·ª•</th>
                            <th>S·ªë ki·ªán</th>
                            <th>Tr·ªçng l∆∞·ª£ng</th>
                            <th>Th·ªÉ t√≠ch</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="dichVuTrongBang"></td>
                            <td id="soKien"></td>
                            <td id="tlThuc"></td>
                            <td id="thetich"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="notes-table">
                <table>
                    <thead>
                        <tr>
                            <th>N·ªôi dung h√†ng ho√°</th>
                            <th>Ghi ch√∫</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="noiDungHangHoa"></td>
                            <td id="ghiChu"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="side-content">
            <div class="item">
                <span class="label">H√¨nh th·ª©c thanh to√°n:</span>
                <span class="value" id="thanhToan"></span>
            </div>
            <div class="item-separator"></div>
            <div class="item">
                <span class="label">C∆∞·ªõc ch√≠nh:</span>
                <span class="value-money" id="cuocChinh"></span>
            </div>
            <div class="item">
                <span class="label">D·ªãch v·ª• c·ªông th√™m:</span>
                <span class="value-money" id="dichVuThem"></span>
            </div>
            <div class="item">
                <span class="label">T·ªïng c∆∞·ªõc:</span>
                <span class="value-money" id="tongCuoc"></span>
            </div>
            <div class="total-cost">
                <span class="label">Thu h·ªô:</span>
                <span class="value-money" id="thuHo"></span>
            </div>
            <div class="total-cost">
                <span class="label">T·ªïng ph·∫£i thu:</span>
                <span class="value-money" id="tongPhaiThu"></span>
            </div>
        </div>
    </div>
    
    <!-- Ph·∫ßn ch·ªØ k√Ω -->
    <div class="signature-section">
        <div class="signature-box border-right">
            <p class="date-time">Ng√†y gi·ªù g·ª≠i: <span id="ngayGioGui"></span></p>
            <p>H·ªç t√™n v√† ch·ªØ k√Ω ng∆∞·ªùi g·ª≠i</p>
        </div>
        <div class="signature-box border-right">
            <p class="date-time">Ng√†y gi·ªù nh·∫≠n . . . . . . . . . . . . . . . . . . . .</p>
            <p>Nh√¢n vi√™n nh·∫≠n k√Ω</p>
        </div>
        <div class="signature-box">
            <p class="date-time">Ng√†y gi·ªù nh·∫≠n . . . . . . . . . . . . . . . . . .  . .</p>
            <p>H·ªç t√™n v√† ch·ªØ k√Ω ng∆∞·ªùi nh·∫≠n</p>
        </div>
    </div>

    <!-- Footer: D·ªãch v·ª• v√† c√°c t√πy ch·ªçn kh√°c -->
    <div class="footer">
        <div class="qr-note-container">
            <img class="qr-code" src="https://tuducdat2001-cyber.github.io/bill/z6886848621829_aea68d7f33a412bd56c8271a3a15fe26.jpg" alt="M√£ QR">
            <p class="qr-note">
                Qu√Ω kh√°ch vui l√≤ng qu√©t m√£ QR ƒë·ªÉ xem<br>
                Ch√≠nh s√°ch ƒë·ªÅn b√π v√† ƒëi·ªÅu ki·ªán chuy·ªÉn ph√°t
            </p>
        </div>
        <div class="footer-right">
             <button class="print-button" onclick="window.print()">üñ® In h√≥a ƒë∆°n</button>
        </div>
        </div>
    </div>
</div>

<!-- View: Qu·∫£n L√Ω Xe -->
<div id="vehicles-view" class="view-container">
    <div class="form-container">
        <h3>üöõ Th√™m Xe M·ªõi</h3>
        <form id="vehicle-form">
            <div class="grid-2">
                <div class="form-group">
                    <label for="bienKiemSoat">Bi·ªÉn Ki·ªÉm So√°t *</label>
                    <input type="text" id="bienKiemSoat" required>
        </div>
                <div class="form-group">
                    <label for="tenNhaCungCap">T√™n Nh√† Cung C·∫•p *</label>
                    <input type="text" id="tenNhaCungCap" required>
    </div>
                <div class="form-group">
                    <label for="laiXe">L√°i Xe</label>
                    <input type="text" id="laiXe">
        </div>
                <div class="form-group">
                    <label for="sbtLaiXe">SBT L√°i Xe</label>
                    <input type="text" id="sbtLaiXe">
                </div>
                <div class="form-group">
                    <label for="ngayXuat">Ng√†y Xu·∫•t *</label>
                    <input type="date" id="ngayXuat" required>
                </div>
                <div class="form-group">
                    <label for="trangThai">Tr·∫°ng Th√°i *</label>
                    <select id="trangThai" required>
                        <option value="Ch·ªù x·∫øp h√†ng">Ch·ªù x·∫øp h√†ng</option>
                        <option value="ƒêang v·∫≠n chuy·ªÉn">ƒêang v·∫≠n chuy·ªÉn</option>
                        <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                        <option value="H·ªßy">H·ªßy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ngayDuKien">Ng√†y D·ª± Ki·∫øn</label>
                    <input type="date" id="ngayDuKien">
                </div>
                <div class="form-group">
                    <label for="trangThaiThanhToan">Tr·∫°ng Th√°i Thanh To√°n</label>
                    <select id="trangThaiThanhToan">
                        <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
                        <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
                        <option value="Thanh to√°n m·ªôt ph·∫ßn">Thanh to√°n m·ªôt ph·∫ßn</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="ghiChuXe">Ghi Ch√∫</label>
                <textarea id="ghiChuXe" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-success">‚ûï Th√™m Xe</button>
        </form>
        </div>
        
    <div class="form-container">
        <h3>üöõ Danh S√°ch Xe</h3>
        <table class="data-table" id="vehicles-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Bi·ªÉn Ki·ªÉm So√°t</th>
                    <th>Nh√† Cung C·∫•p</th>
                    <th>L√°i Xe</th>
                    <th>SBT L√°i Xe</th>
                    <th>Tr·∫°ng Th√°i</th>
                    <th>Ghi Ch√∫</th>
                    <th>Thao T√°c</th>
                </tr>
            </thead>
            <tbody id="vehicles-tbody">
                <!-- D·ªØ li·ªáu xe s·∫Ω ƒë∆∞·ª£c load t·ª´ Google Sheets -->
            </tbody>
        </table>
    </div>
        </div>
        
<!-- View: X·∫øp Bill Cho Xe -->
<div id="assign-bills-view" class="view-container">
    <div class="form-container">
        <h3>üìã Ch·ªçn Xe</h3>
            <div class="form-group">
            <label for="select-vehicle">Ch·ªçn Xe</label>
            <select id="select-vehicle">
                <option value="">-- Ch·ªçn xe --</option>
            </select>
        </div>
        <button class="btn" onclick="loadBillsForVehicle()">üìã Xem Bill C√≥ Th·ªÉ X·∫øp</button>
            </div>
            
    <div class="form-container" id="bills-assignment-container" style="display: none;">
        <h3>üì¶ Danh S√°ch Bill C√≥ Th·ªÉ X·∫øp</h3>
        <table class="data-table" id="assignable-bills-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-bills"></th>
                    <th>S·ªë Bill</th>
                    <th>Kh√°ch G·ª≠i</th>
                    <th>Kh√°ch Nh·∫≠n</th>
                    <th>ƒê·ªãa Ch·ªâ Nh·∫≠n</th>
                    <th>Tr·ªçng L∆∞·ª£ng</th>
                    <th>COD</th>
                    <th>S·ªë Th·ª© T·ª±</th>
                    <th>S·ªë L∆∞·ª£ng H√†ng</th>
                    <th>Tr·∫°ng Th√°i</th>
                </tr>
            </thead>
            <tbody id="assignable-bills-tbody">
            </tbody>
        </table>
        <button class="btn btn-success" onclick="assignBillsToVehicle()">‚úÖ X·∫øp Bill Cho Xe</button>
    </div>
            </div>
            
<!-- View: Tr·∫°ng Th√°i Xe -->
<div id="vehicle-status-view" class="view-container">
    <div class="grid-3">
        <div class="form-container">
            <h3>üìä T·ªïng Quan</h3>
            <div id="status-summary">
                <p><strong>T·ªïng s·ªë xe:</strong> <span id="total-vehicles">0</span></p>
                <p><strong>Xe ƒëang ho·∫°t ƒë·ªông:</strong> <span id="active-vehicles">0</span></p>
                <p><strong>Xe ƒë√£ ho√†n th√†nh:</strong> <span id="completed-vehicles">0</span></p>
                <p><strong>T·ªïng s·ªë bill:</strong> <span id="total-bills">0</span></p>
            </div>
            </div>
            
        <div class="form-container">
            <h3>üöõ Chi Ti·∫øt Xe</h3>
            <div class="form-group">
                <label for="status-vehicle-select">Ch·ªçn Xe</label>
                <select id="status-vehicle-select">
                    <option value="">-- Ch·ªçn xe ƒë·ªÉ xem chi ti·∫øt --</option>
                </select>
            </div>
            </div>
            
        <div class="form-container">
            <h3>üìã Bill C·ªßa Xe</h3>
            <div id="vehicle-bills-details">
                <p>Ch·ªçn xe ƒë·ªÉ xem danh s√°ch bill</p>
            </div>
        </div>
            </div>
            
    <div class="form-container">
        <h3>üìä B·∫£ng Tr·∫°ng Th√°i Chi Ti·∫øt</h3>
        <table class="data-table" id="vehicle-status-table">
            <thead>
                <tr>
                    <th>Bi·ªÉn Ki·ªÉm So√°t</th>
                    <th>Nh√† Cung C·∫•p</th>
                    <th>L√°i Xe</th>
                    <th>Tr·∫°ng Th√°i</th>
                    <th>S·ªë Bill</th>
                    <th>T·ªïng COD</th>
                    <th>Ng√†y Xu·∫•t</th>
                    <th>D·ª± Ki·∫øn</th>
                </tr>
            </thead>
            <tbody id="vehicle-status-tbody">
            </tbody>
        </table>
    </div>
            </div>
            
<!-- View: ƒê∆°n Ch∆∞a X·∫øp -->
<div id="unassigned-bills-view" class="view-container">
    <div class="form-container">
        <h3>üì¶ ƒê∆°n Ch∆∞a X·∫øp Ho·∫∑c X·∫øp Ch∆∞a H·∫øt</h3>
        <div class="grid-2">
            <div>
                <h4>üìã ƒê∆°n Ch∆∞a X·∫øp</h4>
                <table class="data-table" id="unassigned-bills-table">
                    <thead>
                        <tr>
                            <th>S·ªë Bill</th>
                            <th>Kh√°ch G·ª≠i</th>
                            <th>Kh√°ch Nh·∫≠n</th>
                            <th>ƒê·ªãa Ch·ªâ Nh·∫≠n</th>
                            <th>Tr·ªçng L∆∞·ª£ng</th>
                            <th>COD</th>
                            <th>Ng√†y T·∫°o</th>
                        </tr>
                    </thead>
                    <tbody id="unassigned-bills-tbody">
                    </tbody>
                </table>
            </div>
            
            <div>
                <h4>üöõ Xe C√≥ Th·ªÉ Nh·∫≠n Th√™m Bill</h4>
                <table class="data-table" id="available-vehicles-table">
                    <thead>
                        <tr>
                            <th>Bi·ªÉn Ki·ªÉm So√°t</th>
                            <th>Nh√† Cung C·∫•p</th>
                            <th>L√°i Xe</th>
                            <th>S·ªë Bill Hi·ªán T·∫°i</th>
                            <th>Dung L∆∞·ª£ng C√≤n L·∫°i</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="available-vehicles-tbody">
                    </tbody>
                </table>
            </div>
    </div>
    </div>
        </div>
        
<!-- View: Qu·∫£n L√Ω Bill Tr√™n Xe -->
<div id="vehicle-bills-view" class="view-container">
    <div class="form-container">
        <h3>üìã Qu·∫£n L√Ω Bill Tr√™n Xe</h3>
        <div class="form-group">
            <label for="manage-vehicle-select">Ch·ªçn Xe</label>
            <select id="manage-vehicle-select">
                <option value="">-- Ch·ªçn xe ƒë·ªÉ qu·∫£n l√Ω bill --</option>
            </select>
        </div>
        <button class="btn" onclick="loadVehicleBills()">üìã Xem Bill Tr√™n Xe</button>
        </div>
        
    <div class="form-container" id="vehicle-bills-management" style="display: none;">
        <h3>üì¶ Bill Tr√™n Xe: <span id="selected-vehicle-name"></span></h3>
        <div class="grid-2">
            <div>
                <h4>üìã Danh S√°ch Bill</h4>
                <table class="data-table" id="vehicle-bills-table">
            <thead>
                <tr>
                            <th>S·ªë Th·ª© T·ª±</th>
                    <th>S·ªë Bill</th>
                            <th>Kh√°ch G·ª≠i</th>
                            <th>Kh√°ch Nh·∫≠n</th>
                            <th>Tr·ªçng L∆∞·ª£ng</th>
                            <th>COD</th>
                            <th>S·ªë L∆∞·ª£ng H√†ng</th>
                    <th>Thao T√°c</th>
                </tr>
            </thead>
                    <tbody id="vehicle-bills-tbody">
            </tbody>
        </table>
    </div>
            
            <div>
                <h4>‚úèÔ∏è S·ª≠a Th√¥ng Tin Bill</h4>
                <form id="edit-bill-form" style="display: none;">
                    <div class="form-group">
                        <label for="edit-bill-number">S·ªë Bill</label>
                        <input type="text" id="edit-bill-number" readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-bill-order">S·ªë Th·ª© T·ª± *</label>
                        <input type="number" id="edit-bill-order" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-bill-quantity">S·ªë L∆∞·ª£ng H√†ng *</label>
                        <input type="number" id="edit-bill-quantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-bill-weight">Tr·ªçng L∆∞·ª£ng (kg)</label>
                        <input type="number" id="edit-bill-weight" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-bill-cod">COD (VNƒê)</label>
                        <input type="number" id="edit-bill-cod" min="0">
                    </div>
                    <button type="submit" class="btn btn-success">üíæ L∆∞u Thay ƒê·ªïi</button>
                    <button type="button" class="btn btn-danger" onclick="cancelEditBill()">‚ùå H·ªßy</button>
                </form>
                
                <div id="no-bill-selected">
                    <p>Ch·ªçn bill t·ª´ b·∫£ng ƒë·ªÉ ch·ªânh s·ª≠a</p>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <h4>üìä T·ªïng K·∫øt Xe</h4>
            <div class="grid-3">
                <div>
                    <p><strong>T·ªïng s·ªë bill:</strong> <span id="total-bills-on-vehicle">0</span></p>
                    <p><strong>T·ªïng tr·ªçng l∆∞·ª£ng:</strong> <span id="total-weight-on-vehicle">0</span> kg</p>
                </div>
                <div>
                    <p><strong>T·ªïng COD:</strong> <span id="total-cod-on-vehicle">0</span> VNƒê</p>
                    <p><strong>T·ªïng s·ªë l∆∞·ª£ng h√†ng:</strong> <span id="total-quantity-on-vehicle">0</span></p>
                </div>
                <div>
                    <button class="btn btn-warning" onclick="reorderBills()">üîÑ S·∫Øp X·∫øp L·∫°i</button>
                    <button class="btn btn-danger" onclick="removeAllBills()">üóëÔ∏è X√≥a T·∫•t C·∫£ Bill</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View: D·ªØ Li·ªáu Local -->
<div id="local-data-view" class="view-container">
    <div class="form-container">
        <h3>üíæ D·ªØ Li·ªáu ƒê∆∞·ª£c L∆∞u T·∫°m Th·ªùi</h3>
        <p>D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u v√†o localStorage khi ch∆∞a c√≥ API Key ƒë·ªÉ k·∫øt n·ªëi Google Sheets.</p>
        
        <div class="grid-2">
            <div>
                <h4>üöõ Xe (LocalStorage)</h4>
                <div id="local-vehicles" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu xe trong localStorage</p>
                </div>
                <button class="btn" onclick="loadLocalVehicles()">üîÑ T·∫£i L·∫°i</button>
                <button class="btn btn-danger" onclick="clearLocalVehicles()">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
            </div>
            
            <div>
                <h4>üìã Assignments (LocalStorage)</h4>
                <div id="local-assignments" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f9f9f9;">
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu assignment trong localStorage</p>
                </div>
                <button class="btn" onclick="loadLocalAssignments()">üîÑ T·∫£i L·∫°i</button>
                <button class="btn btn-danger" onclick="clearLocalAssignments()">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
            </div>
        </div>
        
        <div class="form-container">
            <h4>üìù H∆∞·ªõng D·∫´n C·∫•u H√¨nh cho Vercel</h4>
            <ol>
                <li><strong>Truy c·∫≠p:</strong> <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                <li><strong>T·∫°o project m·ªõi</strong> ho·∫∑c ch·ªçn project hi·ªán c√≥</li>
                <li><strong>Enable Google Sheets API</strong> trong Library</li>
                <li><strong>T·∫°o Service Account:</strong> IAM & Admin ‚Üí Service Accounts ‚Üí Create Service Account</li>
                <li><strong>T·∫£i file JSON credentials</strong> v√† copy to√†n b·ªô n·ªôi dung</li>
                <li><strong>Deploy l√™n Vercel:</strong> <code>vercel</code> trong terminal</li>
                <li><strong>C·∫•u h√¨nh Environment Variable:</strong> Vercel Dashboard ‚Üí Environment Variables ‚Üí Th√™m <code>GOOGLE_API_SERVICES</code></li>
                <li><strong>Chia s·∫ª Google Sheets</strong> v·ªõi email service account: <code>sgiholding@ansha-462603.iam.gserviceaccount.com</code></li>
            </ol>
            
            <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-top: 15px;">
                <strong>‚úÖ ƒê√£ c·∫•u h√¨nh cho Vercel Deployment!</strong><br>
                Sheet: <a href="https://docs.google.com/spreadsheets/d/1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4" target="_blank">Google Sheets</a><br>
                Sheet ID: 1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4<br>
                Sheet Name: "Xe" (cho d·ªØ li·ªáu xe)<br><br>
                <strong>üìù B∆∞·ªõc ti·∫øp theo cho Vercel:</strong><br>
                1. Copy to√†n b·ªô n·ªôi dung file JSON service account<br>
                2. V√†o Vercel Dashboard ‚Üí Environment Variables<br>
                3. Th√™m bi·∫øn: <code>GOOGLE_API_SERVICES</code><br>
                4. Paste JSON v√†o value<br>
                5. Chia s·∫ª Google Sheets v·ªõi: <code>sgiholding@ansha-462603.iam.gserviceaccount.com</code><br>
                6. C·∫•p quy·ªÅn <strong>"Editor"</strong><br><br>
                <strong>üí° T·∫°m th·ªùi:</strong> D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o localStorage
            </div>
            
            <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin-top: 15px;">
                <strong>üéâ Sau khi chia s·∫ª Google Sheets:</strong><br>
                - ‚úÖ Th√™m xe m·ªõi ‚Üí L∆∞u v√†o Google Sheets sheet "Xe"<br>
                - ‚úÖ X·∫øp bill cho xe ‚Üí T·∫°o assignment records<br>
                - ‚úÖ S·ª≠a th√¥ng tin ‚Üí C·∫≠p nh·∫≠t real-time<br>
                - ‚úÖ X√≥a d·ªØ li·ªáu ‚Üí X√≥a kh·ªèi Google Sheets<br>
                - ‚úÖ Fallback localStorage n·∫øu l·ªói
            </div>
        </div>
    </div>
</div>

<script>
    // ===== C·∫§U H√åNH GOOGLE SHEETS =====
    const SHEET_CONFIG = {
        BILL_SHEET_ID: '1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4',
        BILL_SHEET_RANGE: 'Sheet1!A:AH',
        VEHICLE_SHEET_ID: '1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4',
        VEHICLE_SHEET_RANGE: 'Xe!A:K', // S·ª≠ d·ª•ng sheet "Xe"
        ASSIGNMENT_SHEET_ID: '1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4',
        ASSIGNMENT_SHEET_RANGE: 'Sheet3!A:J' // ID, Bill_ID, Vehicle_ID, Order, Quantity, Weight, COD, Status, Created_Date, Notes
    };

    // ===== BI·∫æN TO√ÄN C·ª§C =====
    let vehiclesData = [];
    let billsData = [];
    let assignmentsData = []; // D·ªØ li·ªáu x·∫øp h√†ng (li√™n k·∫øt Bill v√† Xe)
    let currentView = 'bill';
    let nextAssignmentId = 1; // ID ti·∫øp theo cho assignment

    // ===== HELPER FUNCTION =====
    function getSheetId(type) {
        let configKey;
        if (type === 'vehicles') {
            configKey = 'VEHICLE_SHEET_ID';
        } else if (type === 'bills') {
            configKey = 'BILL_SHEET_ID';
        } else if (type === 'assignments') {
            configKey = 'ASSIGNMENT_SHEET_ID';
        } else {
            configKey = `${type.toUpperCase()}_SHEET_ID`;
        }
        
        const sheetId = SHEET_CONFIG[configKey];
        if (!sheetId) {
            throw new Error(`Sheet ID not found for type: ${type}, configKey: ${configKey}`);
        }
        return sheetId;
    }

    // ===== H√ÄM CHUY·ªÇN VIEW =====
    function showView(viewName) {
        // ·∫®n t·∫•t c·∫£ view
        document.querySelectorAll('.view-container').forEach(view => {
            view.classList.remove('active');
        });
        
        // B·ªè active t·∫•t c·∫£ nav button
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Hi·ªÉn th·ªã view ƒë∆∞·ª£c ch·ªçn
        document.getElementById(viewName + '-view').classList.add('active');
        document.querySelector(`[onclick="showView('${viewName}')"]`).classList.add('active');
        
        currentView = viewName;
        
        // Load d·ªØ li·ªáu khi chuy·ªÉn view
        if (viewName === 'vehicles') {
            loadVehicles();
        } else if (viewName === 'assign-bills') {
            loadVehiclesForAssignment();
        } else if (viewName === 'vehicle-status') {
            loadVehicleStatus();
        } else if (viewName === 'unassigned-bills') {
            loadUnassignedBills();
        } else if (viewName === 'vehicle-bills') {
            loadVehiclesForBillManagement();
        } else if (viewName === 'local-data') {
            loadLocalData();
        }
    }

    // ===== H√ÄM L·∫§Y D·ªÆ LI·ªÜU T·ª™ GOOGLE SHEETS =====
    async function loadDataFromSheets() {
        try {
            // Load d·ªØ li·ªáu t·ª´ Google Sheets s·ª≠ d·ª•ng API key
            const [vehicles, bills, assignments] = await Promise.all([
                readFromGoogleSheets('vehicles', 'Xe'),
                readFromGoogleSheets('bills', 'Sheet1'),
                readFromGoogleSheets('assignments', 'Sheet3')
            ]);
            
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu global
            window.vehiclesData = vehicles;
            window.billsData = bills;
            window.assignmentsData = assignments;
            
            console.log('‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets');
            console.log(`üìä Bills: ${bills.length} records`);
            console.log(`üöõ Vehicles: ${vehicles.length} records`);
            console.log(`üìã Assignments: ${assignments.length} records`);
            
            return { 
                vehicles: vehicles, 
                bills: bills,
                assignments: assignments
            };
        } catch (error) {
            console.error('‚ùå L·ªói khi load d·ªØ li·ªáu t·ª´ Google Sheets:', error);
            // S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u n·∫øu kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c
            return {
                vehicles: [
                    ['ID', 'NgayXuat', 'TrangThai', 'GhiChu', 'NgayDuKien', 'T√™n nh√† cung c·∫•p', 'Tr·∫°ng th√°i thanh to√°n', 'Bi·ªÉn ki·ªÉm so√°t', 'L√°i xe', 'SBT l√°i xe', 'Ghi ch√∫'],
                    ['1', '16/08/2025', 'ƒêang v·∫≠n chuy·ªÉn', 'DUNG3C', '19/08/2025', 'D≈©ng 3 ch√¢n', 'ƒê√£ thanh to√°n', '51A-12345', 'Nguy·ªÖn VƒÉn A', '123456789', 'Xe t·∫£i 3 ch√¢n'],
                    ['2', '12/09/2025', 'Ch·ªù x·∫øp h√†ng', 'Chi·∫øn 3 ch√¢n', '2025-09-15', 'Chi·∫øn 3 ch√¢n', 'Ch∆∞a thanh to√°n', '51B-67890', 'Tr·∫ßn VƒÉn B', '987654321', 'Xe t·∫£i 3 ch√¢n']
                ],
                bills: [
                    ['ID', 'S·ªë Bill', 'Ng√†y b·ªëc', 'M√£ kh√°ch g·ª≠i', 'T√™n kh√°ch g·ª≠i', 'T·ªânh', 'X√£', 'ƒê·ªãa ch·ªâ', 'ƒê·ªãa ch·ªâ ƒë√£ l∆∞u', 'T√™n kh√°ch nh·∫≠n', 'ƒê·ªãa ch·ªâ nh·∫≠n', 'T·ªânh nh·∫≠n', 'X√£ nh·∫≠n', 'SƒêT kh√°ch nh·∫≠n', 'D·ªãch v·ª• GTGT', 'N·ªôi dung h√†ng h√≥a', 'S·ªë ki·ªán', 'Tr·ªçng l∆∞·ª£ng th·ª±c', 'Th·ªÉ t√≠ch', 'ƒê∆°n v·ªã t√≠nh c∆∞·ªõc', 'ƒê∆°n gi√°', 'Ph·ª• ph√≠', 'VAT', 'Th√†nh ti·ªÅn', 'Ng∆∞·ªùi thanh to√°n', 'COD', 'Tr·∫°ng th√°i thanh to√°n', 'Ghi ch√∫'],
                    ['1', '105409', '10/08/2025', 'CMAYKHOTHAN', 'Ch·ªã M√¢y-kho than', 'Th·ªã Xu√¢n', 'Khu CNTT ƒê√† N·∫µng, Ph∆∞·ªùng Li√™n Chi·ªÉu, Th√†nh ph·ªë ƒê√† N·∫µng', 'ƒê√† N·∫µng', 'Chuy·ªÉn ph√°t nhanh', '6-7411-4', '4', '1.87', '413', 'L√¥/Tr·ªçn g√≥i', '1.215.500', '454.545', '0%', '1.715.500', 'Ng∆∞·ªùi g·ª≠i', '0', 'C√¥ng n·ª£'],
                    ['2', '105449', '12/08/2025', 'CMAYKHOTHAN', 'Ch·ªã M√¢y-kho than', '31 Nguy·ªÖn Cao Luy·ªán , TP ƒê√† N·∫µng', 'ƒê√† N·∫µng', 'Chuy·ªÉn ph√°t nhanh', '9-951-2', '2', '0.80', '177', 'L√¥/Tr·ªçn g√≥i', '520.000', '363.636', '0%', '920.000', 'Ng∆∞·ªùi g·ª≠i', '0', 'C√¥ng n·ª£']
                ],
                assignments: [
                    ['ID', 'Bill_ID', 'Vehicle_ID', 'Order', 'Quantity', 'Weight', 'COD', 'Status', 'Created_Date', 'Notes'],
                    ['1', '1', '1', '1', '4', '1.87', '0', 'Assigned', '2025-01-15', 'Bill ƒë·∫ßu ti√™n tr√™n xe 1'],
                    ['2', '2', '1', '2', '2', '0.80', '0', 'Assigned', '2025-01-15', 'Bill th·ª© hai tr√™n xe 1']
                ]
            };
        }
    }

    // ===== H√ÄM L·∫§Y GI√Å TR·ªä T·ª™ URL PARAMETER =====
    function getParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name) || '';
    }

    // ===== SERVICE ACCOUNT CONFIG =====
    const SERVICE_ACCOUNT = {
        "type": "service_account",
        "project_id": "ansha-462603",
        "private_key_id": "21b679e96ff406593cbd2bbb8e3d1a99429bca62",
        "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDad8k6sku6rC1y\nUMca8UaGeBRoAnnKQPiP8mhgkSxFD+73PiLuDgmS2QV89mV4fpJ22jjcoxC1ARRt\njm1QsleHLZtXu2rNXg2Y4U6CZbUA6w9g6F6fm+Y98xIsayFdqI/tk7r1lAV5hhj3\nBf2e2Ai0kjhnw89H/BJk/t6HGQxzRkBZ4z1h8qt7dnU1m5lFZtr7qUjfoHEogx5e\nXGb3iN/lJGDovOCcRqmdUlp16uNNE7lD/hYJrGhS8cBCu5x6/LKdIKRi68eGpFn8\nJ7BqtPEbS9svk1S9gOk6ndzYEE0A0bq1g9KMUZrx2THXQ2w+QcI9zc3uxVVjkEh9\nJ/upGTgxAgMBAAECggEADnPRMJxd7SX5xa+5VDt05m1oMC9Fvk8JAoDPTeActR7m\nOJ34MpZkJL5NoiQst0lsSAeMrm/tKYQ+RTcgXS/HIY6vUaD44kggDyaMiozO6hYi\nyM7mf5mRJDUB1UVrCiaeCuH0gs19hToNSb4wNoNlJAjuSVMHUeRHlT3VG8vY6oEy\ncT7FBvwzPQzgBWe8EU78iWOVJAh5mJWhSBET0DZ92geTQUY9urExgFjwFU1y00hb\nJKo10e4rDqwjkOQQXHllLF18zwTRQCUA2jWAQI1/LNRB8eF6DAIo/PaCQ4mShTHJ\nleRkOyXRwKvQvk+cTiahurb7O218EfCwBtXeiiFlLwKBgQDyFFkKYEho2mWnV541\nINYdW36s4xzXw8zxCrcjmBOCamHfx1+/nqzA6ICmHgWsdWmUyppCP4jiKgCCUO/j\ne0w0jDvOoHZWiqe1tCD5xhGCmFFqaOusHp6W+OcpK86HwdoZgTZTpqAFuNSON1Lc\nW3vLExtEps6jKxaacyUt71zElwKBgQDnB9oxP+M6UXaJ4xUSH5oq/SEo9Ikr6n/r\nn/j/3VRalb+uz/eYviE79fO4SQsGyzHllmQQe2ZWQJvYaScGSiIPuHX+JcxuiT4n\nrcYHgV9WKjRZj+wv/NiFB7q0JHyyRqeiKwENMvvXRI7Qq6PDmI3vw/FG+etyoYjy\nD3MPYuGadwKBgFfOD5nW4Iy/op13B1hn56HQXPsiiYStbXmElHbhoznrkkKT02Py\njuCNtJQMUayDDd+9OQSMfP7jkzmxV8GgKDzrHIpO431yX3BlvIw8Tn+a9fTtx4Wv\nuYAzGc1yKUBOjOgxWN4wktxgdSB8ap6oxBcdgAd/pXXDnDg7SaIGrxRTAoGAc8Rz\niYpCCs8XXzDzNgmv7yq4mxUuR1tSjnezBkOaKWowiyCbKWbcsHcmkYnIhLb9YdZi\nff/X4BCwB1lpvLUZLFd6iMfYEOukwa1KNiiV5U9wvBBqggFpXf/phqth8NOG3LQ/\n6qVJnS01g0r+3NxtA2BkXvSNDvvy65jiRyt9cTECgYAbZVf6rkJoiAkM5hpEqWXT\nFx8tPS+/sNFUms8C5yVp8Y3BSYixRHnNg3kGj8ah5o97N/5QiCmRq7Bs+tC+m6cB\n3ikrmpKLUYep2/VP9uBk08DXFkkHc5XrAQW/GLBYNCz1mI+VYY86VrfS3pFBA89r\nlo9NlrFz2dD6uwbtkx2rEw==\n-----END PRIVATE KEY-----\n",
        "client_email": "sgiholding@ansha-462603.iam.gserviceaccount.com",
        "client_id": "106296932444121411612",
        "auth_uri": "https://accounts.google.com/o/oauth2/auth",
        "token_uri": "https://oauth2.googleapis.com/token",
        "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
        "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/sgiholding%40ansha-462603.iam.gserviceaccount.com",
        "universe_domain": "googleapis.com"
    };

    // ===== H√ÄM L∆ØU D·ªÆ LI·ªÜU V√ÄO GOOGLE SHEETS =====
    async function saveToGoogleSheets(type, data, sheetName) {
        try {
            const sheetId = getSheetId(type);
            
            // Debug logging
            console.log('saveToGoogleSheets called with:', { type, sheetName, sheetId, dataLength: data?.length });
            
            const requestBody = {
                action: 'append',
                sheetId: sheetId,
                sheetName: sheetName,
                data: data
            };
            
            console.log('Request body:', requestBody);
            
            const response = await fetch('/api/google-sheets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error(`‚ùå L·ªói khi l∆∞u ${type} v√†o Google Sheets:`, error);
            throw error;
        }
    }

    // ===== H√ÄM L·∫§Y ACCESS TOKEN T·ª™ SERVICE ACCOUNT =====
    async function getServiceAccountToken() {
        try {
            // T·∫°o JWT token cho service account
            const now = Math.floor(Date.now() / 1000);
            
            const header = {
                "alg": "RS256",
                "typ": "JWT"
            };
            
            const payload = {
                "iss": SERVICE_ACCOUNT.client_email,
                "scope": "https://www.googleapis.com/auth/spreadsheets",
                "aud": SERVICE_ACCOUNT.token_uri,
                "exp": now + 3600,
                "iat": now
            };
            
            // T·∫°o JWT token
            const jwt = await createJWT(header, payload, SERVICE_ACCOUNT.private_key);
            
            // L·∫•y access token t·ª´ Google
            const response = await fetch(SERVICE_ACCOUNT.token_uri, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`
            });
            
            if (!response.ok) {
                throw new Error(`Token request failed: ${response.status}`);
            }
            
            const tokenData = await response.json();
            return tokenData.access_token;
        } catch (error) {
            console.error('‚ùå L·ªói khi l·∫•y access token:', error);
            throw error;
        }
    }

    // ===== H√ÄM T·∫†O JWT TOKEN =====
    async function createJWT(header, payload, privateKey) {
        try {
            // Encode header v√† payload
            const encodedHeader = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const encodedPayload = btoa(JSON.stringify(payload)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            // T·∫°o signature (simplified - trong th·ª±c t·∫ø c·∫ßn d√πng th∆∞ vi·ªán crypto)
            const signature = btoa(encodedHeader + '.' + encodedPayload).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            return `${encodedHeader}.${encodedPayload}.${signature}`;
        } catch (error) {
            console.error('‚ùå L·ªói khi t·∫°o JWT:', error);
            throw error;
        }
    }

    // ===== H√ÄM L∆ØU D·ªÆ LI·ªÜU V√ÄO GOOGLE SHEETS =====
    async function saveVehicleToSheet(vehicleData) {
        try {
            // S·ª≠ d·ª•ng Google Sheets API tr·ª±c ti·∫øp ƒë·ªÉ l∆∞u d·ªØ li·ªáu
            await saveToGoogleSheets('vehicles', vehicleData, 'Xe');
            console.log('‚úÖ ƒê√£ l∆∞u xe v√†o Google Sheets');
            return true;
        } catch (error) {
            console.error('‚ùå L·ªói khi l∆∞u xe:', error);
            
            // Fallback: l∆∞u v√†o localStorage
            saveToLocalStorage('vehicles', vehicleData);
            
            // Hi·ªÉn th·ªã th√¥ng b√°o chi ti·∫øt
            if (error.message.includes('403')) {
                alert('‚ö†Ô∏è L·ªói quy·ªÅn truy c·∫≠p API.\nD·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m th·ªùi v√†o localStorage.\nVui l√≤ng ki·ªÉm tra API Key v√† chia s·∫ª Google Sheets.');
            } else if (error.message.includes('Failed to fetch')) {
                alert('‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi m·∫°ng.\nD·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m th·ªùi v√†o localStorage.');
            } else {
                alert('‚ö†Ô∏è L·ªói khi l∆∞u xe: ' + error.message + '\nD·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m th·ªùi v√†o localStorage.');
            }
            
            return false;
        }
    }

    async function saveAssignmentToSheet(assignmentData) {
        try {
            await saveToGoogleSheets('assignments', assignmentData, 'Sheet3');
            console.log('‚úÖ ƒê√£ l∆∞u assignment v√†o Google Sheets');
        } catch (error) {
            console.error('‚ùå L·ªói khi l∆∞u assignment:', error);
            saveToLocalStorage('assignments', assignmentData);
        }
    }

    async function updateAssignmentInSheet(assignmentData) {
        try {
            const sheetId = SHEET_CONFIG.ASSIGNMENT_SHEET_ID;
            const rowIndex = parseInt(assignmentData[0]);
            
            const response = await fetch('/api/google-sheets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'update',
                    sheetId: sheetId,
                    sheetName: 'Sheet3',
                    data: assignmentData,
                    rowIndex: rowIndex
                })
            });
            
            if (response.ok) {
                console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t assignment trong Google Sheets');
            } else {
                const errorData = await response.json();
                console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t assignment:', errorData.error || response.statusText);
            }
        } catch (error) {
            console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t assignment:', error);
        }
    }

    // ===== H√ÄM ƒê·ªåC D·ªÆ LI·ªÜU T·ª™ GOOGLE SHEETS =====
    async function readFromGoogleSheets(type, sheetName) {
        try {
            const sheetId = getSheetId(type);
            
            // Debug logging
            console.log('readFromGoogleSheets called with:', { type, sheetName, sheetId });
            
            const requestBody = {
                action: 'read',
                sheetId: sheetId,
                sheetName: sheetName
            };
            
            console.log('Read request body:', requestBody);
            
            const response = await fetch('/api/google-sheets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
            }
            
            const data = await response.json();
            return data.values || [];
        } catch (error) {
            console.error(`‚ùå L·ªói khi ƒë·ªçc ${type} t·ª´ Google Sheets:`, error);
            throw error;
        }
    }

    // ===== H√ÄM X√ìA D·ªÆ LI·ªÜU T·ª™ GOOGLE SHEETS =====
    async function deleteFromGoogleSheets(type, sheetName, rowIndex) {
        try {
            const sheetId = getSheetId(type);
            
            const response = await fetch('/api/google-sheets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'delete',
                    sheetId: sheetId,
                    sheetName: sheetName,
                    rowIndex: rowIndex
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
            }
            
            console.log(`‚úÖ ƒê√£ x√≥a d√≤ng ${rowIndex} t·ª´ ${sheetName}`);
            return true;
        } catch (error) {
            console.error(`‚ùå L·ªói khi x√≥a d·ªØ li·ªáu t·ª´ Google Sheets:`, error);
            throw error;
        }
    }

    // ===== H√ÄM X√ìA XE =====
    async function deleteVehicle(vehicleId) {
        try {
            // X√≥a t·ª´ Google Sheets
            await deleteFromGoogleSheets('vehicles', 'Sheet2', vehicleId);
            
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu local
            vehiclesData = vehiclesData.filter(vehicle => vehicle[0] !== vehicleId);
            
            // Reload danh s√°ch xe
            displayVehicles();
            
            alert('‚úÖ ƒê√£ x√≥a xe th√†nh c√¥ng!');
        } catch (error) {
            console.error('‚ùå L·ªói khi x√≥a xe:', error);
            alert('‚ùå L·ªói khi x√≥a xe. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    // ===== H√ÄM X√ìA ASSIGNMENT =====
    async function deleteAssignment(assignmentId) {
        try {
            // X√≥a t·ª´ Google Sheets
            await deleteFromGoogleSheets('assignments', 'Sheet3', assignmentId);
            
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu local
            assignmentsData = assignmentsData.filter(assignment => assignment[0] !== assignmentId);
            
            alert('‚úÖ ƒê√£ x√≥a assignment th√†nh c√¥ng!');
        } catch (error) {
            console.error('‚ùå L·ªói khi x√≥a assignment:', error);
            alert('‚ùå L·ªói khi x√≥a assignment. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    // ===== H√ÄM FALLBACK - L∆ØU V√ÄO LOCALSTORAGE =====
    function saveToLocalStorage(type, data) {
        try {
            const existingData = JSON.parse(localStorage.getItem(type) || '[]');
            existingData.push(data);
            localStorage.setItem(type, JSON.stringify(existingData));
            console.log(`‚úÖ ƒê√£ l∆∞u ${type} v√†o localStorage`);
        } catch (error) {
            console.error(`‚ùå L·ªói khi l∆∞u ${type} v√†o localStorage:`, error);
        }
    }

    function loadFromLocalStorage(type) {
        try {
            const data = JSON.parse(localStorage.getItem(type) || '[]');
            return data;
        } catch (error) {
            console.error(`‚ùå L·ªói khi load ${type} t·ª´ localStorage:`, error);
            return [];
        }
    }

    // ===== H√ÄM X·ª¨ L√ù LOCAL DATA VIEW =====
    function loadLocalData() {
        loadLocalVehicles();
        loadLocalAssignments();
    }

    function loadLocalVehicles() {
        const vehicles = loadFromLocalStorage('vehicles');
        const container = document.getElementById('local-vehicles');
        
        if (vehicles.length === 0) {
            container.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu xe trong localStorage</p>';
            return;
        }
        
        let html = '<table class="data-table"><thead><tr><th>ID</th><th>Bi·ªÉn KS</th><th>Nh√† CC</th><th>L√°i Xe</th><th>Tr·∫°ng Th√°i</th></tr></thead><tbody>';
        
        vehicles.forEach(vehicle => {
            html += `<tr>
                <td>${vehicle[0]}</td>
                <td>${vehicle[7]}</td>
                <td>${vehicle[5]}</td>
                <td>${vehicle[8]}</td>
                <td>${vehicle[2]}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function loadLocalAssignments() {
        const assignments = loadFromLocalStorage('assignments');
        const container = document.getElementById('local-assignments');
        
        if (assignments.length === 0) {
            container.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu assignment trong localStorage</p>';
            return;
        }
        
        let html = '<table class="data-table"><thead><tr><th>ID</th><th>Bill ID</th><th>Vehicle ID</th><th>Order</th><th>Quantity</th><th>Status</th></tr></thead><tbody>';
        
        assignments.forEach(assignment => {
            html += `<tr>
                <td>${assignment[0]}</td>
                <td>${assignment[1]}</td>
                <td>${assignment[2]}</td>
                <td>${assignment[3]}</td>
                <td>${assignment[4]}</td>
                <td>${assignment[7]}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function clearLocalVehicles() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu xe trong localStorage?')) {
            localStorage.removeItem('vehicles');
            loadLocalVehicles();
            alert('‚úÖ ƒê√£ x√≥a d·ªØ li·ªáu xe trong localStorage');
        }
    }

    function clearLocalAssignments() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu assignment trong localStorage?')) {
            localStorage.removeItem('assignments');
            loadLocalAssignments();
            alert('‚úÖ ƒê√£ x√≥a d·ªØ li·ªáu assignment trong localStorage');
        }
    }

    // ===== H√ÄM X·ª¨ L√ù XE =====
    async function loadVehicles() {
        try {
            const data = await loadDataFromSheets();
            vehiclesData = data.vehicles;
            assignmentsData = data.assignments;
            displayVehicles();
        } catch (error) {
            console.error('L·ªói khi load xe:', error);
        }
    }

    function displayVehicles() {
        const tbody = document.getElementById('vehicles-tbody');
        tbody.innerHTML = '';
        
        if (vehiclesData.length <= 1) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ch∆∞a c√≥ d·ªØ li·ªáu xe</td></tr>';
            return;
        }
        
        // B·ªè qua header row
        for (let i = 1; i < vehiclesData.length; i++) {
            const row = vehiclesData[i];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row[0] || ''}</td>
                <td>${row[7] || ''}</td>
                <td>${row[5] || ''}</td>
                <td>${row[8] || ''}</td>
                <td>${row[9] || ''}</td>
                <td><span class="status-badge status-${getStatusClass(row[2])}">${row[2] || 'Ch∆∞a x√°c ƒë·ªãnh'}</span></td>
                <td>${row[10] || ''}</td>
                <td>
                    <button class="btn btn-warning" onclick="editVehicle(${i})">‚úèÔ∏è S·ª≠a</button>
                    <button class="btn btn-danger" onclick="deleteVehicle('${row[0]}')">üóëÔ∏è X√≥a</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }

    function getStatusClass(status) {
        switch(status) {
            case 'ƒêang v·∫≠n chuy·ªÉn': return 'active';
            case 'Ch·ªù x·∫øp h√†ng': return 'pending';
            case 'Ho√†n th√†nh': return 'completed';
            case 'H·ªßy': return 'cancelled';
            default: return 'pending';
        }
    }

    // ===== H√ÄM S·ª¨A XE =====
    function editVehicle(index) {
        const vehicle = vehiclesData[index];
        if (!vehicle) {
            alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin xe!');
            return;
        }
        
        // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
        document.getElementById('bienKiemSoat').value = vehicle[7] || '';
        document.getElementById('tenNhaCungCap').value = vehicle[5] || '';
        document.getElementById('laiXe').value = vehicle[8] || '';
        document.getElementById('sbtLaiXe').value = vehicle[9] || '';
        document.getElementById('ngayXuat').value = vehicle[1] || '';
        document.getElementById('trangThai').value = vehicle[2] || '';
        document.getElementById('ngayDuKien').value = vehicle[4] || '';
        document.getElementById('trangThaiThanhToan').value = vehicle[6] || '';
        document.getElementById('ghiChuXe').value = vehicle[10] || '';
        
        // Scroll to form
        document.getElementById('vehicle-form').scrollIntoView({ behavior: 'smooth' });
        
        alert('ƒê√£ ƒëi·ªÅn th√¥ng tin xe v√†o form. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a v√† l∆∞u l·∫°i.');
    }

    // ===== H√ÄM TH√äM XE M·ªöI =====
    document.getElementById('vehicle-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            bienKiemSoat: document.getElementById('bienKiemSoat').value,
            tenNhaCungCap: document.getElementById('tenNhaCungCap').value,
            laiXe: document.getElementById('laiXe').value,
            sbtLaiXe: document.getElementById('sbtLaiXe').value,
            ngayXuat: document.getElementById('ngayXuat').value,
            trangThai: document.getElementById('trangThai').value,
            ngayDuKien: document.getElementById('ngayDuKien').value,
            trangThaiThanhToan: document.getElementById('trangThaiThanhToan').value,
            ghiChu: document.getElementById('ghiChuXe').value
        };
        
        try {
            // Th√™m xe m·ªõi v√†o d·ªØ li·ªáu v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin
            const newId = vehiclesData.length; // ID m·ªõi (trong th·ª±c t·∫ø s·∫Ω l·∫•y t·ª´ database)
            const newVehicle = [
                newId.toString(),
                formData.ngayXuat,
                formData.trangThai,
                formData.ghiChu,
                formData.ngayDuKien,
                formData.tenNhaCungCap,
                formData.trangThaiThanhToan,
                formData.bienKiemSoat,
                formData.laiXe,
                formData.sbtLaiXe,
                formData.ghiChu
            ];
            
            vehiclesData.push(newVehicle);
            
            // L∆∞u v√†o Google Sheets
            const savedToSheets = await saveVehicleToSheet(newVehicle);
            
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            if (savedToSheets) {
                alert('‚úÖ Th√™m xe th√†nh c√¥ng!\nD·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o Google Sheets.');
            } else {
                alert('‚úÖ Th√™m xe th√†nh c√¥ng!\nD·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m th·ªùi v√†o localStorage.\nVui l√≤ng c·∫•u h√¨nh Google Apps Script ƒë·ªÉ l∆∞u v√†o Google Sheets.');
            }
            
            // Reset form
            document.getElementById('vehicle-form').reset();
            
            // Reload danh s√°ch xe
            displayVehicles();
            
        } catch (error) {
            console.error('L·ªói khi th√™m xe:', error);
            alert('‚ùå C√≥ l·ªói x·∫£y ra khi th√™m xe!');
        }
    });

    // ===== H√ÄM X·ª¨ L√ù X·∫æP BILL CHO XE =====
    async function loadVehiclesForAssignment() {
        try {
            const data = await loadDataFromSheets();
            vehiclesData = data.vehicles;
            billsData = data.bills;
            assignmentsData = data.assignments;
            
            const select = document.getElementById('select-vehicle');
            select.innerHTML = '<option value="">-- Ch·ªçn xe --</option>';
            
            // B·ªè qua header row
            for (let i = 1; i < vehiclesData.length; i++) {
                const row = vehiclesData[i];
                const option = document.createElement('option');
                option.value = row[0]; // S·ª≠ d·ª•ng ID thay v√¨ index
                option.textContent = `${row[7]} - ${row[5]} (${row[2]})`;
                select.appendChild(option);
            }
        } catch (error) {
            console.error('L·ªói khi load xe cho x·∫øp bill:', error);
        }
    }

    async function loadBillsForVehicle() {
        const vehicleId = document.getElementById('select-vehicle').value;
        if (!vehicleId) {
            alert('Vui l√≤ng ch·ªçn xe!');
            return;
        }
        
        try {
            const tbody = document.getElementById('assignable-bills-tbody');
            tbody.innerHTML = '';
            
            // Hi·ªÉn th·ªã container
            document.getElementById('bills-assignment-container').style.display = 'block';
            
            // L·∫•y danh s√°ch bill ch∆∞a ƒë∆∞·ª£c x·∫øp cho xe n√†y
            const availableBills = getAvailableBillsForVehicle(vehicleId);
            
            availableBills.forEach((bill, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="bill-checkbox" value="${bill.id}"></td>
                    <td>${bill.billNumber || ''}</td>
                    <td>${bill.sender || ''}</td>
                    <td>${bill.receiver || ''}</td>
                    <td>${bill.address || ''}</td>
                    <td>${bill.weight || ''} kg</td>
                    <td>${bill.cod || '0'} VNƒê</td>
                    <td><input type="number" class="bill-order" value="${index + 1}" min="1" style="width: 60px;"></td>
                    <td><input type="number" class="bill-quantity" value="1" min="1" style="width: 60px;"></td>
                    <td><span class="status-badge status-pending">Ch∆∞a x·∫øp</span></td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('L·ªói khi load bill:', error);
        }
    }

    // H√†m l·∫•y danh s√°ch bill c√≥ th·ªÉ x·∫øp cho xe
    function getAvailableBillsForVehicle(vehicleId) {
        const availableBills = [];
        
        // B·ªè qua header row
        for (let i = 1; i < billsData.length; i++) {
            const bill = billsData[i];
            const billId = bill[0]; // ID c·ªßa bill
            
            // Ki·ªÉm tra xem bill ƒë√£ ƒë∆∞·ª£c x·∫øp cho xe n√†y ch∆∞a
            const isAlreadyAssigned = assignmentsData.some(assignment => 
                assignment[1] === billId && assignment[2] === vehicleId && assignment[7] !== 'Removed'
            );
            
            if (!isAlreadyAssigned) {
                availableBills.push({
                    id: billId,
                    billNumber: bill[1],
                    sender: bill[4],
                    receiver: bill[9],
                    address: bill[10],
                    weight: bill[17],
                    cod: bill[25]
                });
            }
        }
        
        return availableBills;
    }

    async function assignBillsToVehicle() {
        const selectedBills = document.querySelectorAll('.bill-checkbox:checked');
        if (selectedBills.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt bill!');
            return;
        }
        
        const vehicleId = document.getElementById('select-vehicle').value;
        const vehicle = vehiclesData.find(v => v[0] === vehicleId);
        
        if (!vehicle) {
            alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin xe!');
            return;
        }
        
        // L·∫•y th√¥ng tin s·ªë th·ª© t·ª± v√† s·ªë l∆∞·ª£ng cho t·ª´ng bill
        const billAssignments = [];
        selectedBills.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const billId = checkbox.value;
            const order = row.querySelector('.bill-order').value;
            const quantity = row.querySelector('.bill-quantity').value;
            
            // T√¨m th√¥ng tin bill t·ª´ billsData
            const billData = billsData.find(b => b[0] === billId);
            
            billAssignments.push({
                billId: billId,
                order: parseInt(order),
                quantity: parseInt(quantity),
                billData: billData
            });
        });
        
        // S·∫Øp x·∫øp theo th·ª© t·ª±
        billAssignments.sort((a, b) => a.order - b.order);
        
        // T·∫°o assignment records
        const newAssignments = [];
        billAssignments.forEach(assignment => {
            const assignmentId = nextAssignmentId++;
            const newAssignment = [
                assignmentId.toString(),
                assignment.billId,
                vehicleId,
                assignment.order.toString(),
                assignment.quantity.toString(),
                assignment.billData[17] || '0', // Weight
                assignment.billData[25] || '0', // COD
                'Assigned',
                new Date().toISOString().split('T')[0],
                `Bill ${assignment.billData[1]} x·∫øp l√™n xe ${vehicle[7]}`
            ];
            
            newAssignments.push(newAssignment);
            assignmentsData.push(newAssignment);
        });
        
        alert(`‚úÖ ƒê√£ x·∫øp ${selectedBills.length} bill cho xe ${vehicle[7]}!\nTh·ª© t·ª±: ${billAssignments.map(b => `${b.billData[1]} (${b.quantity} ki·ªán)`).join(', ')}`);
        
        // L∆∞u assignments v√†o Google Sheets
        for (const assignment of newAssignments) {
            await saveAssignmentToSheet(assignment);
        }
        
        // Reset form
        document.getElementById('select-vehicle').value = '';
        document.getElementById('bills-assignment-container').style.display = 'none';
    }

    // ===== H√ÄM X·ª¨ L√ù TR·∫†NG TH√ÅI XE =====
    async function loadVehicleStatus() {
        try {
            const data = await loadDataFromSheets();
            vehiclesData = data.vehicles;
            billsData = data.bills;
            
            // C·∫≠p nh·∫≠t t·ªïng quan
            updateStatusSummary();
            
            // Load dropdown xe
            const select = document.getElementById('status-vehicle-select');
            select.innerHTML = '<option value="">-- Ch·ªçn xe ƒë·ªÉ xem chi ti·∫øt --</option>';
            
            for (let i = 1; i < vehiclesData.length; i++) {
                const row = vehiclesData[i];
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${row[7]} - ${row[5]}`;
                select.appendChild(option);
            }
            
            // Load b·∫£ng tr·∫°ng th√°i
            displayVehicleStatusTable();
            
        } catch (error) {
            console.error('L·ªói khi load tr·∫°ng th√°i xe:', error);
        }
    }

    function updateStatusSummary() {
        const totalVehicles = vehiclesData.length - 1; // B·ªè header
        const activeVehicles = vehiclesData.filter((row, index) => index > 0 && row[2] === 'ƒêang v·∫≠n chuy·ªÉn').length;
        const completedVehicles = vehiclesData.filter((row, index) => index > 0 && row[2] === 'Ho√†n th√†nh').length;
        const totalBills = billsData.length - 1; // B·ªè header
        
        document.getElementById('total-vehicles').textContent = totalVehicles;
        document.getElementById('active-vehicles').textContent = activeVehicles;
        document.getElementById('completed-vehicles').textContent = completedVehicles;
        document.getElementById('total-bills').textContent = totalBills;
    }

    function displayVehicleStatusTable() {
        const tbody = document.getElementById('vehicle-status-tbody');
        tbody.innerHTML = '';
        
        for (let i = 1; i < vehiclesData.length; i++) {
            const row = vehiclesData[i];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row[7] || ''}</td>
                <td>${row[5] || ''}</td>
                <td>${row[8] || ''}</td>
                <td><span class="status-badge status-${getStatusClass(row[2])}">${row[2] || 'Ch∆∞a x√°c ƒë·ªãnh'}</span></td>
                <td>0</td>
                <td>0 VNƒê</td>
                <td>${row[1] || ''}</td>
                <td>${row[4] || ''}</td>
            `;
            tbody.appendChild(tr);
        }
    }

    // ===== H√ÄM X·ª¨ L√ù ƒê∆†N CH∆ØA X·∫æP =====
    async function loadUnassignedBills() {
        try {
            const data = await loadDataFromSheets();
            vehiclesData = data.vehicles;
            billsData = data.bills;
            
            displayUnassignedBills();
            displayAvailableVehicles();
            
        } catch (error) {
            console.error('L·ªói khi load ƒë∆°n ch∆∞a x·∫øp:', error);
        }
    }

    function displayUnassignedBills() {
        const tbody = document.getElementById('unassigned-bills-tbody');
        tbody.innerHTML = '';
        
        // B·ªè qua header row
        for (let i = 1; i < billsData.length; i++) {
            const row = billsData[i];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row[0] || ''}</td>
                <td>${row[3] || ''}</td>
                <td>${row[8] || ''}</td>
                <td>${row[9] || ''}</td>
                <td>${row[16] || ''} kg</td>
                <td>${row[24] || '0'} VNƒê</td>
                <td>${row[1] || ''}</td>
            `;
            tbody.appendChild(tr);
        }
    }

    function displayAvailableVehicles() {
        const tbody = document.getElementById('available-vehicles-tbody');
        tbody.innerHTML = '';
        
        for (let i = 1; i < vehiclesData.length; i++) {
            const row = vehiclesData[i];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row[7] || ''}</td>
                <td>${row[5] || ''}</td>
                <td>${row[8] || ''}</td>
                <td>0</td>
                <td>C√≤n ch·ªó</td>
                <td>
                    <button class="btn btn-success" onclick="assignBillsToVehicle(${i})">üìã X·∫øp Bill</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }

    // ===== H√ÄM X·ª¨ L√ù QU·∫¢N L√ù BILL TR√äN XE =====
    async function loadVehiclesForBillManagement() {
        try {
            const data = await loadDataFromSheets();
            vehiclesData = data.vehicles;
            billsData = data.bills;
            assignmentsData = data.assignments;
            
            const select = document.getElementById('manage-vehicle-select');
            select.innerHTML = '<option value="">-- Ch·ªçn xe ƒë·ªÉ qu·∫£n l√Ω bill --</option>';
            
            // B·ªè qua header row
            for (let i = 1; i < vehiclesData.length; i++) {
                const row = vehiclesData[i];
                const option = document.createElement('option');
                option.value = row[0]; // S·ª≠ d·ª•ng ID thay v√¨ index
                option.textContent = `${row[7]} - ${row[5]} (${row[2]})`;
                select.appendChild(option);
            }
        } catch (error) {
            console.error('L·ªói khi load xe cho qu·∫£n l√Ω bill:', error);
        }
    }

    async function loadVehicleBills() {
        const vehicleId = document.getElementById('manage-vehicle-select').value;
        if (!vehicleId) {
            alert('Vui l√≤ng ch·ªçn xe!');
            return;
        }
        
        try {
            const vehicle = vehiclesData.find(v => v[0] === vehicleId);
            if (!vehicle) {
                alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin xe!');
                return;
            }
            
            document.getElementById('selected-vehicle-name').textContent = `${vehicle[7]} - ${vehicle[5]}`;
            
            // Hi·ªÉn th·ªã container qu·∫£n l√Ω bill
            document.getElementById('vehicle-bills-management').style.display = 'block';
            
            // Load danh s√°ch bill tr√™n xe t·ª´ assignments
            displayVehicleBillsTable(vehicleId);
            updateVehicleSummary(vehicleId);
            
        } catch (error) {
            console.error('L·ªói khi load bill tr√™n xe:', error);
        }
    }

    function displayVehicleBillsTable(vehicleId) {
        const tbody = document.getElementById('vehicle-bills-tbody');
        tbody.innerHTML = '';
        
        // L·∫•y danh s√°ch bill ƒë√£ x·∫øp cho xe n√†y t·ª´ assignments
        const vehicleAssignments = assignmentsData.filter(assignment => 
            assignment[2] === vehicleId && assignment[7] !== 'Removed'
        );
        
        if (vehicleAssignments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Ch∆∞a c√≥ bill n√†o tr√™n xe n√†y</td></tr>';
            return;
        }
        
        // S·∫Øp x·∫øp theo th·ª© t·ª±
        vehicleAssignments.sort((a, b) => parseInt(a[3]) - parseInt(b[3]));
        
        vehicleAssignments.forEach((assignment, index) => {
            const billId = assignment[1];
            const billData = billsData.find(b => b[0] === billId);
            
            if (billData) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${assignment[3]}</td>
                    <td>${billData[1]}</td>
                    <td>${billData[4]}</td>
                    <td>${billData[9]}</td>
                    <td>${assignment[5]} kg</td>
                    <td>${assignment[6]} VNƒê</td>
                    <td>${assignment[4]}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editBillOnVehicle('${assignment[0]}', '${billData[1]}', ${assignment[3]}, ${assignment[4]}, ${assignment[5]}, ${assignment[6]})">‚úèÔ∏è S·ª≠a</button>
                        <button class="btn btn-danger" onclick="removeBillFromVehicle('${assignment[0]}')">üóëÔ∏è X√≥a</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    function updateVehicleSummary(vehicleId) {
        // L·∫•y danh s√°ch bill ƒë√£ x·∫øp cho xe n√†y
        const vehicleAssignments = assignmentsData.filter(assignment => 
            assignment[2] === vehicleId && assignment[7] !== 'Removed'
        );
        
        // T√≠nh t·ªïng k·∫øt
        const totalBills = vehicleAssignments.length;
        const totalWeight = vehicleAssignments.reduce((sum, assignment) => sum + parseFloat(assignment[5] || 0), 0);
        const totalCod = vehicleAssignments.reduce((sum, assignment) => sum + parseFloat(assignment[6] || 0), 0);
        const totalQuantity = vehicleAssignments.reduce((sum, assignment) => sum + parseInt(assignment[4] || 0), 0);
        
        // C·∫≠p nh·∫≠t UI
        document.getElementById('total-bills-on-vehicle').textContent = totalBills;
        document.getElementById('total-weight-on-vehicle').textContent = totalWeight.toFixed(2);
        document.getElementById('total-cod-on-vehicle').textContent = totalCod.toLocaleString('vi-VN');
        document.getElementById('total-quantity-on-vehicle').textContent = totalQuantity;
    }

    function editBillOnVehicle(assignmentId, billNumber, order, quantity, weight, cod) {
        // Hi·ªÉn th·ªã form ch·ªânh s·ª≠a
        document.getElementById('edit-bill-form').style.display = 'block';
        document.getElementById('no-bill-selected').style.display = 'none';
        
        // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
        document.getElementById('edit-bill-number').value = billNumber;
        document.getElementById('edit-bill-order').value = order;
        document.getElementById('edit-bill-quantity').value = quantity;
        document.getElementById('edit-bill-weight').value = weight;
        document.getElementById('edit-bill-cod').value = cod;
        
        // L∆∞u assignment ID ƒë·ªÉ c·∫≠p nh·∫≠t sau
        document.getElementById('edit-bill-form').dataset.assignmentId = assignmentId;
    }

    function cancelEditBill() {
        document.getElementById('edit-bill-form').style.display = 'none';
        document.getElementById('no-bill-selected').style.display = 'block';
    }

    document.getElementById('edit-bill-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const assignmentId = document.getElementById('edit-bill-form').dataset.assignmentId;
        const newOrder = document.getElementById('edit-bill-order').value;
        const newQuantity = document.getElementById('edit-bill-quantity').value;
        const newWeight = document.getElementById('edit-bill-weight').value;
        const newCod = document.getElementById('edit-bill-cod').value;
        
        // T√¨m v√† c·∫≠p nh·∫≠t assignment
        const assignmentIndex = assignmentsData.findIndex(a => a[0] === assignmentId);
        if (assignmentIndex !== -1) {
            assignmentsData[assignmentIndex][3] = newOrder; // Order
            assignmentsData[assignmentIndex][4] = newQuantity; // Quantity
            assignmentsData[assignmentIndex][5] = newWeight; // Weight
            assignmentsData[assignmentIndex][6] = newCod; // COD
            
            // L∆∞u v√†o Google Sheets
            await updateAssignmentInSheet(assignmentsData[assignmentIndex]);
        }
        
        alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t bill!\nS·ªë th·ª© t·ª±: ${newOrder}\nS·ªë l∆∞·ª£ng: ${newQuantity}\nTr·ªçng l∆∞·ª£ng: ${newWeight} kg\nCOD: ${newCod} VNƒê`);
        
        // ·∫®n form
        cancelEditBill();
        
        // Reload b·∫£ng
        const vehicleId = document.getElementById('manage-vehicle-select').value;
        displayVehicleBillsTable(vehicleId);
        updateVehicleSummary(vehicleId);
    });

    async function removeBillFromVehicle(assignmentId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a bill n√†y kh·ªèi xe?')) {
            try {
                // X√≥a assignment kh·ªèi Google Sheets
                await deleteAssignment(assignmentId);
                
                // Reload b·∫£ng
                const vehicleId = document.getElementById('manage-vehicle-select').value;
                displayVehicleBillsTable(vehicleId);
                updateVehicleSummary(vehicleId);
                
                alert('‚úÖ ƒê√£ x√≥a bill kh·ªèi xe th√†nh c√¥ng!');
            } catch (error) {
                console.error('‚ùå L·ªói khi x√≥a bill kh·ªèi xe:', error);
                alert('‚ùå L·ªói khi x√≥a bill. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
    }

    function reorderBills() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën s·∫Øp x·∫øp l·∫°i th·ª© t·ª± bill theo s·ªë th·ª© t·ª±?')) {
            const vehicleId = document.getElementById('manage-vehicle-select').value;
            
            // L·∫•y t·∫•t c·∫£ assignments c·ªßa xe n√†y v√† s·∫Øp x·∫øp l·∫°i
            const vehicleAssignments = assignmentsData.filter(assignment => 
                assignment[2] === vehicleId && assignment[7] !== 'Removed'
            );
            
            vehicleAssignments.sort((a, b) => parseInt(a[3]) - parseInt(b[3]));
            
            // C·∫≠p nh·∫≠t l·∫°i s·ªë th·ª© t·ª±
            vehicleAssignments.forEach((assignment, index) => {
                const assignmentIndex = assignmentsData.findIndex(a => a[0] === assignment[0]);
                if (assignmentIndex !== -1) {
                    assignmentsData[assignmentIndex][3] = (index + 1).toString();
                }
            });
            
            alert('‚úÖ ƒê√£ s·∫Øp x·∫øp l·∫°i th·ª© t·ª± bill!');
            
            // Reload b·∫£ng
            displayVehicleBillsTable(vehicleId);
        }
    }

    function removeAllBills() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ bill kh·ªèi xe n√†y?')) {
            const vehicleId = document.getElementById('manage-vehicle-select').value;
            
            // ƒê√°nh d·∫•u t·∫•t c·∫£ assignments c·ªßa xe n√†y l√† Removed
            assignmentsData.forEach(assignment => {
                if (assignment[2] === vehicleId && assignment[7] !== 'Removed') {
                    assignment[7] = 'Removed';
                    assignment[9] = `Removed on ${new Date().toISOString().split('T')[0]}`;
                }
            });
            
            alert('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ bill kh·ªèi xe!');
            
            // Reload b·∫£ng
            displayVehicleBillsTable(vehicleId);
            updateVehicleSummary(vehicleId);
        }
    }

    // ===== KH·ªûI T·∫†O TRANG =====
    document.addEventListener('DOMContentLoaded', (event) => {
        // --- Ph·∫ßn l·∫•y d·ªØ li·ªáu v√† c·∫≠p nh·∫≠t giao di·ªán ---

        // M√£ ƒë∆°n h√†ng: L·∫•y t·ª´ URL ho·∫∑c d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥
        const orderNumber = getParam("maDonHang") || "ECO105327"; 

        // T·∫°o m√£ v·∫°ch b·∫±ng JsBarcode
        JsBarcode("#barcode-svg", orderNumber, {
            format: "CODE128", // ƒê·ªãnh d·∫°ng m√£ v·∫°ch
            displayValue: true, // Hi·ªÉn th·ªã gi√° tr·ªã d∆∞·ªõi m√£ v·∫°ch
            fontSize: 18, // K√≠ch th∆∞·ªõc font ch·ªØ
            width: 2,   // ƒê·ªô r·ªông c·ªßa c√°c v·∫°ch
            height: 50, // Chi·ªÅu cao c·ªßa m√£ v·∫°ch
            textAlign: "center" // CƒÉn gi·ªØa m√£ v·∫°ch
        });

        // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi g·ª≠i
        document.getElementById("tenNguoiGui").textContent = getParam("tenNguoiGui");
        document.getElementById("diaChiNguoiGui").textContent = getParam("diaChiNguoiGui");
        document.getElementById("xaPhuongGui").textContent = getParam("xaPhuongGui");
        document.getElementById("tinhTPGui").textContent = getParam("tinhTPGui");
        document.getElementById("sdtNguoiGui").textContent = getParam("sdtNguoiGui");

        // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi nh·∫≠n
        document.getElementById("tenNguoiNhan").textContent = getParam("tenNguoiNhan");
        document.getElementById("diaChiNguoiNhan").textContent = getParam("diaChiNguoiNhan");
        document.getElementById("xaPhuongNhan").textContent = getParam("xaPhuongNhan");
        document.getElementById("tinhTPNhan").textContent = getParam("tinhTPNhan");
        document.getElementById("sdtNguoiNhan").textContent = getParam("sdtNguoiNhan");
        
        // C·∫≠p nh·∫≠t ng√†y gi·ªù g·ª≠i
        document.getElementById("ngayGioGui").textContent = getParam("ngayGioGui");
        
        // C·∫≠p nh·∫≠t th√¥ng tin h√†ng h√≥a
        document.getElementById("soKien").textContent = getParam("soKien");
        const tlThucValue = getParam("tlThuc"); // L·∫•y tr·ªçng l∆∞·ª£ng
        document.getElementById("tlThuc").textContent = tlThucValue ? `${tlThucValue} kg` : ''; // Hi·ªÉn th·ªã k√®m ƒë∆°n v·ªã kg
        const thetichValue = getParam("thetich"); // L·∫•y th·ªÉ t√≠ch
        document.getElementById("thetich").textContent = thetichValue ? `${thetichValue} m¬≥` : ''; // Hi·ªÉn th·ªã k√®m ƒë∆°n v·ªã m¬≥
        document.getElementById("dichVuTrongBang").textContent = getParam("dichVu"); // D·ªãch v·ª• trong b·∫£ng
        document.getElementById("ghiChu").textContent = getParam("ghiChu"); // Ghi ch√∫
        document.getElementById("noiDungHangHoa").textContent = getParam("noiDungHangHoa"); // N·ªôi dung h√†ng h√≥a

        // C·∫≠p nh·∫≠t th√¥ng tin c∆∞·ªõc ph√≠ v√† ƒë·ªãnh d·∫°ng l·∫°i
        document.getElementById("thanhToan").textContent = getParam("thanhToan"); // H√¨nh th·ª©c thanh to√°n
        document.getElementById("cuocChinh").textContent = formatCurrency(getParam("cuocChinh")); // C∆∞·ªõc ch√≠nh, ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
        document.getElementById("dichVuThem").textContent = formatCurrency(getParam("dichVuThem")); // D·ªãch v·ª• th√™m, ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
        document.getElementById("tongCuoc").textContent = formatCurrency(getParam("tongCuoc")); // T·ªïng c∆∞·ªõc, ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
        document.getElementById("thuHo").textContent = formatCurrency(getParam("thuHo")); // Ti·ªÅn thu h·ªô, ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
        document.getElementById("tongPhaiThu").textContent = formatCurrency(getParam("tongPhaiThu")); // T·ªïng ph·∫£i thu, ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
        
        // üöÄ T·ª± ƒë·ªông g·ªçi l·ªánh in khi trang ƒë√£ t·∫£i xong v√† d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn
        // B·ªè comment d√≤ng d∆∞·ªõi n·∫øu b·∫°n mu·ªën h√≥a ƒë∆°n t·ª± ƒë·ªông b·∫≠t h·ªôp tho·∫°i in khi m·ªü.
        window.print(); 
    });

    // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá (th√™m d·∫•u ph·∫©y ngƒÉn c√°ch h√†ng ngh√¨n v√† s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng ti·∫øng Vi·ªát)
    function formatCurrency(amount) {
        // Lo·∫°i b·ªè t·∫•t c·∫£ c√°c k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
        const cleanedAmount = String(amount).replace(/\D/g, '');
        // N·∫øu chu·ªói sau khi l√†m s·∫°ch r·ªóng, tr·∫£ v·ªÅ '0'
        if (!cleanedAmount) return '0';
        // Chuy·ªÉn ƒë·ªïi th√†nh s·ªë nguy√™n v√† ƒë·ªãnh d·∫°ng theo chu·∫©n VNƒê
        return parseInt(cleanedAmount, 10).toLocaleString('vi-VN');
    }
</script>

<!-- 
========================================
GOOGLE APPS SCRIPT CODE
========================================
Copy code n√†y v√†o Google Apps Script (script.google.com):

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const { action, sheetId, sheetName, data: rowData, rowIndex, serviceAccount } = data;
    
    // X·ª≠ l√Ω getToken action
    if (action === 'getToken') {
      return getServiceAccountToken(serviceAccount);
    }
    
    // M·ªü spreadsheet
    const spreadsheet = SpreadsheetApp.openById(sheetId);
    const sheet = spreadsheet.getSheetByName(sheetName);
    
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({
        error: `Sheet ${sheetName} not found`
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    switch (action) {
      case 'append':
        // Th√™m d·ªØ li·ªáu m·ªõi
        sheet.appendRow(rowData);
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          message: 'Data appended successfully'
        })).setMimeType(ContentService.MimeType.JSON);
        
      case 'read':
        // ƒê·ªçc d·ªØ li·ªáu
        const values = sheet.getDataRange().getValues();
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          values: values
        })).setMimeType(ContentService.MimeType.JSON);
        
      case 'update':
        // C·∫≠p nh·∫≠t d·ªØ li·ªáu
        const rowNum = rowData[0]; // ID l√† c·ªôt ƒë·∫ßu ti√™n
        sheet.getRange(rowNum, 1, 1, rowData.length).setValues([rowData]);
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          message: 'Data updated successfully'
        })).setMimeType(ContentService.MimeType.JSON);
        
      case 'delete':
        // X√≥a d√≤ng
        sheet.deleteRow(rowIndex);
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          message: 'Row deleted successfully'
        })).setMimeType(ContentService.MimeType.JSON);
        
      default:
        return ContentService.createTextOutput(JSON.stringify({
          error: 'Invalid action'
        })).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function getServiceAccountToken(serviceAccount) {
  try {
    // T·∫°o JWT token cho service account
    const now = Math.floor(Date.now() / 1000);
    
    const header = {
      "alg": "RS256",
      "typ": "JWT"
    };
    
    const payload = {
      "iss": serviceAccount.client_email,
      "scope": "https://www.googleapis.com/auth/spreadsheets",
      "aud": serviceAccount.token_uri,
      "exp": now + 3600,
      "iat": now
    };
    
    // T·∫°o JWT token
    const jwt = createJWT(header, payload, serviceAccount.private_key);
    
    // L·∫•y access token t·ª´ Google
    const response = UrlFetchApp.fetch(serviceAccount.token_uri, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      payload: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`
    });
    
    const tokenData = JSON.parse(response.getContentText());
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      access_token: tokenData.access_token
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function createJWT(header, payload, privateKey) {
  // Encode header v√† payload
  const encodedHeader = Utilities.base64EncodeWebSafe(JSON.stringify(header)).replace(/=/g, '');
  const encodedPayload = Utilities.base64EncodeWebSafe(JSON.stringify(payload)).replace(/=/g, '');
  
  // T·∫°o signature (simplified)
  const signature = Utilities.base64EncodeWebSafe(encodedHeader + '.' + encodedPayload).replace(/=/g, '');
  
  return `${encodedHeader}.${encodedPayload}.${signature}`;
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    message: 'Google Sheets API Proxy is running'
  })).setMimeType(ContentService.MimeType.JSON);
}

========================================
H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG:
========================================
1. Truy c·∫≠p https://script.google.com
2. T·∫°o project m·ªõi
3. Copy code tr√™n v√†o editor
4. Save project
5. Deploy ‚Üí New Deployment ‚Üí Web App
6. Execute as: Me
7. Who has access: Anyone
8. Deploy
9. Copy URL v√† thay YOUR_SCRIPT_ID trong code HTML
10. Chia s·∫ª Google Sheets v·ªõi sgiholding@ansha-462603.iam.gserviceaccount.com
-->

</body>
</html>
